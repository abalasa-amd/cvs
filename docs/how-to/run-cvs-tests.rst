.. meta::
  :description: Run CVS test scripts
  :keywords: CVS, health, network, tests, RCCL 

***********************************
Run Cluster Validation Suites tests
***********************************

You can list available tests using either `cvs run` (with no arguments) or `cvs list`:

.. code:: bash

  cvs run
  cvs list

.. code:: text

  Available tests:
    - agfhc_cvs
    - babelstream_cvs
    - csp_qual_agfhc
    - distributed_llama3_1_405b
    - distributed_llama3_1_70b
    - distributed_llama3_1_8b
    - distributed_llama_3_1_70b
    - host_configs_cvs
    - ib_perf_bw_test
    - install_agfhc
    - install_babelstream
    - install_ibperf_tools
    - install_rocblas
    - install_rvs
    - install_transferbench
    - jax_llama3_1_405b_training
    - jax_llama3_1_70b_training
    - jax_llama_training
    - megatron_llama_training
    - rccl_multinode_cvs
    - rccl_multinode_default_cvs
    - rccl_singlenode_cvs
    - rocblas_cvs
    - rvs_cvs
    - singlenode_llama_3_1_70b
    - singlenode_llama_3_1_8b
    - transferbench_cvs


Run all tests in a file:

.. code:: bash

   cvs run agfhc_cvs --cluster_file input/cluster_file/cluster.json --config_file input/config_file/health/mi300_health_config.json --html=/var/www/html/cvs/agfhc.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

Run a specific test function:

.. code:: bash

   cvs run agfhc_cvs test_agfhc_hbm --cluster_file input/cluster_file/cluster.json --config_file input/config_file/health/mi300_health_config.json --html=/var/www/html/cvs/agfhc.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

Collect tests only (dry run):

.. code:: bash

   cvs run agfhc_cvs --collect-only

All pytest options (such as `--html`, `--self-contained-html`, `--log-file`, `--capture`, `-vvv`, `-s`, etc.) can be passed to `cvs run`.

These are the arguments typically used in these test scripts:

- ``--log-file``: The text log file where the Python logger outputs are captured.
- ``--cluster_file``: The location of the cluster file, which has the details of the cluster, IPs, and access details.
- ``--config_file``: This is the configuration file used for the test. Depending on the test suite being run, the configuration might vary. The sample input files are organized as sub-directories under the ``cvs/input`` folder, similar to the PyTests.
- ``--html``: This is the output HTML report file generated by PyTest at the end of the script. It has a summary of the number of test cases that have passed/failed. You can navigate to the logs directly in the browser from this report.
- ``--capture=tee-sys``: Captures all ``std.out`` and ``std.err`` writes from your tests.
- ``--self-contained-html``: Generate as a single HTML report, including the styling and embedded images for all test cases.
- ``-vvv``: Increase verbosity of pytest output (can be used for debugging).
- ``-s``: Disable output capturing (shows print statements and logs directly in the console).

You can also create a wrapper shell script to run multiple test suites sequentially by putting the different `cvs run` commands in a bash script as described in the README file under the ``cvs/tests/health`` folder.

Run CVS test scripts
====================

Platform test script
--------------------

The host check scripts can validate various host-side configurations, such as model load balancing enablement, PCIe checks, kernel version, and ROCm version.

You can list all available host check test cases using the CLI:

.. code:: bash

  cvs list host_configs_cvs

.. code:: text

  Available tests in host_configs_cvs:
    - test_check_os_release
    - test_check_kernel_version
    - test_check_bios_version
    - test_check_rocm_version
    - test_check_gpu_fw_version
    - test_check_pci_realloc
    - test_check_iommu_pt
    - test_check_numa_balancing
    - test_check_online_memory
    - test_check_pci_accelerators
    - test_check_pci_speed_width
    - test_check_pci_acs
    - test_check_dmesg_driver_errors

Here's the test script:

.. code:: bash

  cvs run host_configs_cvs --cluster_file input/cluster_file/cluster.json --config_file input/config_file/platform/host_config.json --html=/var/www/html/cvs/host.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

Burn-in health test scripts
---------------------------

The burn-in health tests are single node diagnostic tests that validate the hardware and firmware versions' functionality and performance. 
For the performance validation, they use the reference bandwidth or latency numbers provided as part of the input ``config_file`` for the relevant test. 

Use these scripts to run each health test. These CVS test scripts have two parts: installing the functionality and running the tests.

AGFHC
~~~~~

See the `AGFHC (AMD GPU Field Health Check) <https://instinct.docs.amd.com/projects/gpu-operator/en/latest/test/agfhc.html>`_ docs for more information.

You can list all available AGFHC test cases using the CLI:

.. code:: bash

  cvs list agfhc_cvs

.. code:: text

  Available tests in agfhc_cvs:
    - test_agfhc_hbm
    - test_agfhc_hbm1_lvl5
    - test_agfhc_hbm2_lvl5
    - test_agfhc_hbm3_lvl3
    - test_agfhc_dma_all_lvl1
    - test_agfhc_dma_lvl1
    - test_agfhc_gfx_lvl1
    - test_agfhc_pcie_lvl1
    - test_agfhc_pcie_lvl3
    - test_agfhc_xgmi_lvl1
    - test_agfhc_all_perf
    - test_agfhc_all_lvl5

Use these scripts to start the test:

1. Run the installation: 

   .. code:: bash 

     cvs run install_agfhc --cluster_file input/cluster_file/cluster.json --config_file input/config_file/health/mi300_health_config.json --html=/var/www/html/cvs/agfhc.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

2. Run the AGFHC test:

   .. code:: bash
    
     cvs run agfhc_cvs --cluster_file input/cluster_file/cluster.json --config_file input/config_file/health/mi300_health_config.json --html=/var/www/html/cvs/agfhc.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

3. Run the CSP qualification test:

   .. code:: bash
    
     cvs run csp_qual_agfhc --cluster_file input/cluster_file/cluster.json --config_file input/config_file/health/mi300_health_config.json --html=/var/www/html/cvs/agfhc.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

TransferBench
~~~~~~~~~~~~~

See the `TransferBench <https://rocm.docs.amd.com/projects/TransferBench/en/latest/install/install.html#install-transferbench>`_ docs for more information.

You can list all available TransferBench test cases using the CLI:

.. code:: bash

  cvs list transferbench_cvs

.. code:: text

  Available tests in transferbench_cvs:
    - test_transfer_bench_example_tests_1_6_t
    - test_transfer_bench_a2a
    - test_transfer_bench_p2p
    - test_transfer_bench_healthcheck
    - test_transfer_bench_a2asweep
    - test_transfer_bench_scaling
    - test_transfer_bench_schmoo

Use these scripts to start the test:

1. Run the installation: 

   .. code:: bash

     cvs run install_transferbench --cluster_file input/cluster_file/cluster.json --config_file input/config_file/health/mi300_health_config.json --html=/var/www/html/cvs/transferbench.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

2. Start the TransferBench test:

   .. code:: bash
    
     cvs run transferbench_cvs --cluster_file input/cluster_file/cluster.json --config_file input/config_file/health/mi300_health_config.json --html=/var/www/html/cvs/transferbench.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

RVS
~~~

See the `ROCm Validation Suite (RVS) <https://rocm.docs.amd.com/projects/ROCmValidationSuite/en/latest/install/installation.html>`_ docs for more information.

You can list all available RVS test cases using the CLI:

.. code:: bash

  cvs list rvs_cvs

.. code:: text

  Available tests in rvs_cvs:
    - test_rvs_level_config
    - test_rvs_gpu_enumeration
    - test_rvs_gpup_single
    - test_rvs_mem_test
    - test_rvs_gst_single
    - test_rvs_iet_single
    - test_rvs_pebb_single
    - test_rvs_pbqt_single
    - test_rvs_peqt_single
    - test_rvs_rcqt_single
    - test_rvs_tst_single
    - test_rvs_babel_stream

Use these scripts to start the test:

1. Run the installation: 

   .. code:: bash

     cvs run install_rvs --cluster_file input/cluster_file/cluster.json --config_file input/config_file/health/mi300_health_config.json --html=/var/www/html/cvs/rvs.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

2. Start the RVS test: 

   .. code:: bash
    
     cvs run rvs_cvs --cluster_file input/cluster_file/cluster.json --config_file input/config_file/health/mi300_health_config.json --html=/var/www/html/cvs/rvs.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

InfiniBand (IB Perf) test script
--------------------------------

You can list all available IB Perf test cases using the CLI:

.. code:: bash

  cvs list ib_perf_bw_test

.. code:: text

  Available tests in ib_perf_bw_test:
    - test_ib_bw_perf
    - test_ib_bw_perf
    - test_ib_bw_perf
    - test_ib_lat_perf
    - test_ib_lat_perf
    - test_build_ib_bw_perf_chart
    - test_build_ib_lat_perf_chart

Use these scripts to start the test:

1. Run the installation: 

   .. code:: bash

     cvs run install_ibperf_tools --cluster_file input/cluster_file/cluster.json --config_file input/config_file/ibperf/ibperf_config.json --html=/var/www/html/cvs/ib.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

2. Start the IB Perf test:

   .. code:: bash

     cvs run ib_perf_bw_test --cluster_file input/cluster_file/cluster.json --config_file input/config_file/ibperf/ibperf_config.json --html=/var/www/html/cvs/ib.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

ROCm Communication Collectives Library (RCCL) test script
---------------------------------------------------------


You can list all available RCCL multinode test cases using the CLI:

.. code:: bash

  cvs list rccl_multinode_cvs

.. code:: text

  Available tests in rccl_multinode_cvs:
    - test_collect_hostinfo
    - test_collect_networkinfo
    - test_disable_firewall
    - test_rccl_perf
    - test_gen_graph

.. code:: bash

  cvs list rccl_singlenode_cvs

.. code:: text

  Available tests in rccl_singlenode_cvs:
    - test_collect_hostinfo
    - test_collect_networkinfo
    - test_disable_firewall
    - test_singlenode_perf
    - test_singlenode_perf
    - test_singlenode_perf
    - test_singlenode_perf
    - test_singlenode_perf
    - test_singlenode_perf
    - test_singlenode_perf
    - test_singlenode_perf
    - test_singlenode_perf
    - test_gen_graph

You can run all RCCL multinode tests using the CVS CLI:

.. code:: bash

  cvs run rccl_multinode_cvs --cluster_file input/cluster_file/cluster.json --config_file input/config_file/rccl/rccl_multinode_config.json --html=/var/www/html/cvs/rccl_multinode.html --capture=tee-sys --self-contained-html --log-file=/tmp/rccl_multinode.log -vvv -s

You can run all RCCL singlenode tests using the CVS CLI:

.. code:: bash

  cvs run rccl_singlenode_cvs --cluster_file input/cluster_file/cluster.json --config_file input/config_file/rccl/rccl_singlenode_config.json --html=/var/www/html/cvs/rccl_singlenode.html --capture=tee-sys --self-contained-html --log-file=/tmp/rccl_singlenode.log -vvv -s

JAX training test scripts
You can run all JAX llama training tests using the CVS CLI:

.. code:: bash

  cvs run jax_llama3_1_405b_training --cluster_file input/cluster_file/cluster.json --config_file input/config_file/training/jax/llama3_1_405b_config.json --html=/var/www/html/cvs/jax_llama3_1_405b.html --capture=tee-sys --self-contained-html --log-file=/tmp/jax_llama3_1_405b.log -vvv -s

  cvs run jax_llama3_1_70b_training --cluster_file input/cluster_file/cluster.json --config_file input/config_file/training/jax/llama3_1_70b_config.json --html=/var/www/html/cvs/jax_llama3_1_70b.html --capture=tee-sys --self-contained-html --log-file=/tmp/jax_llama3_1_70b.log -vvv -s

  cvs run jax_llama_training --cluster_file input/cluster_file/cluster.json --config_file input/config_file/training/jax/llama_config.json --html=/var/www/html/cvs/jax_llama.html --capture=tee-sys --self-contained-html --log-file=/tmp/jax_llama.log -vvv -s
-------------------------


You can list all available JAX training test cases using the CLI:

.. code:: bash

  cvs list jax_llama3_1_405b_training

.. code:: text

  Available tests in jax_llama3_1_405b_training:
    - test_disable_firewall
    - test_cleanup_stale_containers
    - test_launch_jax_containers
    - test_llama_3_1_405b_distributed

.. code:: bash

  cvs list jax_llama3_1_70b_training

.. code:: text

  Available tests in jax_llama3_1_70b_training:
    - test_disable_firewall
    - test_cleanup_stale_containers
    - test_launch_jax_containers
    - test_llama_3_1_70b_training

.. code:: bash

  cvs list jax_llama_training

.. code:: text

  Available tests in jax_llama_training:
    - test_cleanup_stale_containers
    - test_launch_jax_containers
    - test_llama_3_1_fp8_distributed

Megatron training test scripts
------------------------------

You can list all available Megatron training test cases using the CLI:

.. code:: bash

  cvs list megatron_llama_training

.. code:: text

  Available tests in megatron_llama_training:
    - test_cleanup_stale_containers
    - test_launch_megatron_containers
    - test_llama_3_1_fp8_single_node
.. code:: bash

  cvs list rocblas_cvs

.. code:: text

  Available tests in rocblas_cvs:
    - test_rocblas_install
    - test_rocblas_fp32_benchmark
    - test_rocblas_bf16_benchmark
    - test_rocblas_int8_benchmark
.. code:: bash

  cvs list singlenode_llama_3_1_70b

.. code:: text

  Available tests in singlenode_llama_3_1_70b:
    - test_cleanup_stale_containers
    - test_launch_megatron_containers
    - test_llama_3_1_fp8_single_node
.. code:: bash

  cvs list singlenode_llama_3_1_8b

.. code:: text

  Available tests in singlenode_llama_3_1_8b:
    - test_cleanup_stale_containers
    - test_launch_megatron_containers
    - test_llama_3_1_fp8_single_node
.. code:: bash

  cvs list rccl_multinode_default_cvs

.. code:: text

  Available tests in rccl_multinode_default_cvs:
    - test_collect_hostinfo
    - test_collect_networkinfo
    - test_disable_firewall
    - test_rccl_perf
    - test_rccl_perf
    - test_rccl_perf
    - test_rccl_perf
    - test_rccl_perf
    - test_rccl_perf
    - test_rccl_perf
    - test_rccl_perf
    - test_rccl_perf
    - test_gen_graph

Use these scripts to run the Megatron tests.

Single Node 8b MI3XX
~~~~~~~~~~~~~~~~~~~~

.. code:: bash

  cvs run singlenode_llama_3_1_8b --cluster_file input/cluster_file/cluster.json --config_file input/config_file/training/megatron/mi3xx_singlenode_megatron_llama.json --html=/var/www/html/cvs/megatron.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

Single Node 8b MI35X
~~~~~~~~~~~~~~~~~~~~

.. code:: bash

  cvs run singlenode_llama_3_1_8b --cluster_file input/cluster_file/cluster.json --config_file input/config_file/training/megatron/mi35x_singlenode_megatron_llama.json --html=/var/www/html/cvs/megatron.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

Single Node 70b MI3XX
~~~~~~~~~~~~~~~~~~~~~

.. code:: bash

  cvs run singlenode_llama_3_1_70b --cluster_file input/cluster_file/cluster.json --config_file input/config_file/training/megatron/mi3xx_singlenode_megatron_llama.json --html=/var/www/html/cvs/megatron.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

Single Node 70b MI35X
~~~~~~~~~~~~~~~~~~~~~

.. code:: bash

  cvs run singlenode_llama_3_1_70b --cluster_file input/cluster_file/cluster.json --config_file input/config_file/training/megatron/mi35x_singlenode_megatron_llama.json --html=/var/www/html/cvs/megatron.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

Distributed 8b
~~~~~~~~~~~~~~

.. code:: bash

  cvs run distributed_llama3_1_8b --cluster_file input/cluster_file/cluster.json --config_file input/config_file/training/megatron/mi3xx_distributed_megatron_llama.json --html=/var/www/html/cvs/megatron.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

Distributed 70b
~~~~~~~~~~~~~~~

.. code:: bash

  cvs run distributed_llama3_1_70b --cluster_file input/cluster_file/cluster.json --config_file input/config_file/training/megatron/mi3xx_distributed_megatron_llama.json --html=/var/www/html/cvs/megatron.html --capture=tee-sys --self-contained-html --log-file=/tmp/test.log -vvv -s

Test results
============

The test output is captured in an HTML report generated by PyTest. 
It provides a summary of the number of test cases that have passed/failed. You can navigate to the logs directly in the browser from this report.

CVS creates a log folder and captures the output of every test in a log file here: ``$HOME/tmp/test.log``

.. tip::

  If there are any errors that prevent the tests from starting, an error message with an appropriate suggestion will be printed in the console.

Test output examples
--------------------

Test results are also displayed on the console.

Here's an example of the output when a test installs the functionality successfully:

.. image:: ../images/install.png

Here's an example of the output when the test runs successfully:

.. image:: ../images/success.png

If the test fails, a message displays in the summary info:

.. image:: ../images/failed.png

You can also cancel tests by pressing **Ctrl-C**:

.. image:: ../images/stop.png

