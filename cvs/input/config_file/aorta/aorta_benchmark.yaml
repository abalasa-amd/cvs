# Aorta Benchmark Test Configuration
# Parsing runs on the host (your venv) from torch_profiler artifacts. Container TraceLens
# analysis is optional; when enabled and available in the image, Excel reports are used
# first, otherwise host parses raw traces (TraceLens in venv or basic JSON parsing).

# Path to Aorta repository on shared filesystem (placeholder resolved from cluster config).
# If the directory does not exist, set aorta_auto_clone: true and aorta_clone_url to clone it.
aorta_path: /scratch/users/{user-id}/aorta
# aorta_auto_clone: false
# aorta_clone_url: "https://github.com/your-org/aorta.git"  # set when using auto-clone

# Container mount point for aorta_path
container_mount_path: /mnt

# Aorta base config file (relative to aorta_path)
# profile_overlap_2gpu.yaml has profiling enabled with compile disabled (works on ROCm)
base_config: config/profile_overlap_2gpu.yaml

# Docker container settings
docker:
  image: jeffdaily/pytorch:torchrec-dlrm-complete
  container_name: aorta-benchmark
  shm_size: 17G
  network_mode: host
  privileged: true

# RCCL build configuration
rccl:
  clone_url: https://github.com/rocm/rccl.git
  branch: develop
  build_path: /mnt/rccl

# NCCL/RCCL environment variables
environment:
  NCCL_MAX_NCHANNELS: 112
  NCCL_MAX_P2P_NCHANNELS: 112
  NCCL_DEBUG: VERSION
  TORCH_NCCL_HIGH_PRIORITY: 1
  OMP_NUM_THREADS: 1
  RCCL_MSCCL_ENABLE: 0

# Short test run (profile_overlap_2gpu.yaml already uses a short profile window)
training_overrides:
  training.max_steps: 15
  profiling.active: 6

# Scripts to execute (using existing Aorta scripts)
# build_script is skipped when skip_rccl_build is true
build_script: scripts/launch_rocm.sh
experiment_script: scripts/launch_rocm.sh

# Hardware
gpus_per_node: 8

# Timeout
timeout_seconds: 3600

# Skip RCCL build for benchmark runs with container-native RCCL
skip_rccl_build: true

# Post-benchmark analysis (optional; host parsing is primary)
# When true, runner tries to generate Excel reports inside the container. If TraceLens
# is not installed in the image, analysis is skipped and host parses raw traces.
analysis:
  enable_tracelens: false
  enable_gemm_analysis: false
  tracelens_script: scripts/tracelens_single_config/run_tracelens_single_config.sh
  gemm_script: scripts/gemm_analysis/run_tracelens_analysis.sh
  skip_if_exists: false

# Expected results (tuned for host raw-trace parsing on MI300; use stricter values with TraceLens Excel reports)
expected_results:
  max_avg_iteration_ms: 12000
  min_compute_ratio: 0.01   # host parsing often 1â€“10%; use 0.5+ for TraceLens/Excel metrics
  min_overlap_ratio: 0.0
  max_time_variance_ratio: 0.5
